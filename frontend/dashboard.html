<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <h2>Dashboard</h2>
            </div>
            <div class="nav-center">
                <div class="search-container">
                    <input type="text" id="search-input" class="search-input" placeholder="Search...">
                    <button class="search-btn" onclick="openAdvancedSearch()">üîç</button>
                </div>
            </div>
            <div class="nav-right">
                <button class="icon-btn" id="messages-btn" onclick="openMessages()" title="Messages">
                    üí¨
                    <span class="badge" id="messages-badge" style="display: none;">0</span>
                </button>
                <button class="icon-btn" id="notifications-btn" onclick="openNotifications()" title="Notifications">
                    üîî
                    <span class="badge" id="notifications-badge" style="display: none;">0</span>
                </button>
                <div class="avatar-container">
                    <div class="avatar" id="user-avatar" onclick="toggleAvatarMenu()">
                        <span id="avatar-initial">U</span>
                    </div>
                    <div class="avatar-menu" id="avatar-menu">
                        <a href="#" onclick="viewProfile()">üë§ Profile</a>
                        <a href="/settings" onclick="event.preventDefault(); window.location.href='/settings'">‚öôÔ∏è Settings</a>
                        <a href="#" onclick="logout()">üö™ Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="section">
            <div class="section-header">
                <h3>CRUD Templates</h3>
                <p style="font-size: 0.85rem; color: var(--text-light); margin: 0;">Choose a template to create a CRUD, or create your own</p>
            </div>
            <div id="templates-grid" class="cards-grid">
                <div class="loading">Loading templates...</div>
            </div>
        </div>

        <div class="section">
            <div class="section-header">
                <h3>My CRUDs</h3>
                <button class="btn btn-primary btn-sm" onclick="openCreateCRUDModal()">+ Create Custom CRUD</button>
            </div>
            <div id="cruds-grid" class="cards-grid">
                <div class="loading">Loading...</div>
            </div>
        </div>

        <div class="section">
            <div class="section-header">
                <h3>Dashboard Items</h3>
                <button class="btn btn-primary btn-sm" onclick="openCreateItemModal()">+ Add Item</button>
            </div>
            <div id="items-grid" class="cards-grid">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Advanced Search Modal -->
    <div id="advanced-search-modal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="closeModal('advanced-search-modal')">&times;</span>
            <h3>Advanced Search</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                <div>
                    <form onsubmit="performAdvancedSearch(event)">
                        <div class="form-group">
                            <label>Search Query</label>
                            <input type="text" id="advanced-query" placeholder="Enter search terms...">
                        </div>
                        <div class="form-group">
                            <label>Type</label>
                            <select id="search-type">
                                <option value="all">All Types (Global Search)</option>
                                <option value="user">Users</option>
                                <option value="dashboard_item">Dashboard Items</option>
                                <option value="custom_crud">Custom CRUDs</option>
                                <option value="message">Messages</option>
                            </select>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label>Location</label>
                                <input type="text" id="search-location" placeholder="City or location">
                            </div>
                            <div class="form-group">
                                <label>Country</label>
                                <input type="text" id="search-country" placeholder="Country">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" id="search-city" placeholder="City">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="use-map-search" onchange="toggleMapSearch()">
                                Use Map Search
                            </label>
                            <small class="form-text">Click on the map to set location</small>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="search-near-me" onchange="toggleSearchNearMe()">
                                üîç Search Near Me
                            </label>
                            <small class="form-text">Search for results near your current location</small>
                        </div>
                        <div id="near-me-options" style="display: none; margin-bottom: 1rem; padding: 1rem; background: var(--light); border-radius: 6px;">
                            <div class="form-group">
                                <label>Search Radius</label>
                                <select id="search-radius">
                                    <option value="1">1 km</option>
                                    <option value="5" selected>5 km</option>
                                    <option value="10">10 km</option>
                                    <option value="25">25 km</option>
                                    <option value="50">50 km</option>
                                    <option value="100">100 km</option>
                                </select>
                                <small class="form-text">Maximum distance from your location</small>
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="setSearchNearMeLocation()" style="width: 100%;">
                                üìç Get My Location
                            </button>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('advanced-search-modal')">Cancel</button>
                            <button type="submit" class="btn btn-primary">Search</button>
                        </div>
                    </form>
                    <div id="search-results" class="search-results" style="margin-top: 1rem; max-height: 300px; overflow-y: auto;"></div>
                </div>
                <div id="map-search-container" style="display: none;">
                    <div class="form-group">
                        <label>Map Search</label>
                        <div id="search-map" style="height: 400px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 1rem;"></div>
                        <div id="map-coordinates" style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 0.5rem;">
                            Click on map to set location
                        </div>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="getCurrentLocation()" style="width: 100%;">
                            üìç Use My Location
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages Modal -->
    <div id="messages-modal" class="modal">
        <div class="modal-content large">
            <span class="close" onclick="closeModal('messages-modal')">&times;</span>
            <h3>Messages</h3>
            <div class="messages-container">
                <div class="messages-sidebar">
                    <div class="messages-search-container">
                        <input type="text" id="message-user-search" class="search-input" placeholder="Search users or admins..." oninput="searchUsersForMessage(event)">
                        <div id="message-user-search-results" class="message-search-results"></div>
                    </div>
                    <div class="conversations-list" id="conversations-list">
                        <div class="loading">Loading conversations...</div>
                    </div>
                </div>
                <div class="messages-view" id="messages-view">
                    <div class="empty-state">Select a conversation or search for a user to start messaging</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notifications-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('notifications-modal')">&times;</span>
            <div class="notifications-header">
                <h3>Notifications</h3>
                <button class="btn btn-sm btn-secondary" onclick="markAllNotificationsRead()">Mark All Read</button>
            </div>
            <div id="notifications-list" class="notifications-list">
                <div class="loading">Loading notifications...</div>
            </div>
        </div>
    </div>

    <!-- Create CRUD Modal -->
    <div id="create-crud-modal" class="modal">
        <div class="modal-content small">
            <span class="close" onclick="closeModal('create-crud-modal')">&times;</span>
            <h3>Create Custom CRUD</h3>
            <form onsubmit="createCRUD(event)">
                <div class="form-group">
                    <label>Display Name</label>
                    <input type="text" id="crud-display-name" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="crud-description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Schema (JSON)</label>
                    <textarea id="crud-schema" rows="6" required>{
  "type": "object",
  "properties": {
    "title": {"type": "string", "description": "Title", "required": true},
    "description": {"type": "string", "description": "Description"}
  },
  "required": ["title"]
}</textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('create-crud-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Item Modal -->
    <div id="create-item-modal" class="modal">
        <div class="modal-content small">
            <span class="close" onclick="closeModal('create-item-modal')">&times;</span>
            <h3>Add Dashboard Item</h3>
            <form onsubmit="createItem(event)">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="item-title" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="item-description" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('create-item-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeModal('profile-modal')">&times;</span>
            <h3>Profile</h3>
            <div id="profile-card-content" class="profile-card">
                <div class="loading">Loading profile...</div>
            </div>
        </div>
    </div>

    <div id="message" class="message"></div>
    <script src="js/app.js"></script>
    <script src="js/dashboard.js"></script>
    <script src="js/navbar.js"></script>
</body>
</html>
